<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Puresign</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial, sans-serif;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
        background-color: #f5f5f7;
      }
      h1 {
        text-align: center;
        color: #333;
      }
      .controls {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .container {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .box {
        flex: 1;
        min-width: 300px;
        background: white;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .box h3 {
        margin-top: 0;
        color: #666;
      }
      img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        display: block;
        object-fit: contain;
        max-height: 500px;
      }

      /* 棋盘格背景，用于展示透明效果 */
      .transparent-bg {
        width: 100%;
        height: 100%;
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #fff;
        background-image:
          linear-gradient(45deg, #eee 25%, transparent 25%),
          linear-gradient(-45deg, #eee 25%, transparent 25%),
          linear-gradient(45deg, transparent 75%, #eee 75%),
          linear-gradient(-45deg, transparent 75%, #eee 75%);
        background-size: 20px 20px;
        background-position:
          0 0,
          0 10px,
          10px -10px,
          -10px 0px;
        border: 1px dashed #ddd;
      }

      button {
        background-color: #007aff;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin-left: 10px;
      }
      button:hover {
        background-color: #0056b3;
      }
      input[type='file'] {
        padding: 10px;
      }
      #status {
        margin-top: 12px;
        color: #666;
        font-size: 12px;
      }
      .check-group {
        display: inline-flex;
        align-items: center;
        margin-left: 15px;
        font-size: 14px;
        color: #333;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <h1>✍️ Puresign</h1>

    <div class="controls">
      <input type="file" id="uploadInput" accept="image/*" />
      <label for="colorInput" style="margin-left: 15px; font-weight: 500">
        文字颜色:
      </label>
      <input
        type="color"
        id="colorInput"
        value="#000000"
        style="vertical-align: middle; cursor: pointer"
      />
      <div class="check-group">
        <input type="checkbox" id="debugMode" />
        <label for="debugMode" style="margin-left: 5px"
          >Debug Mode (显示裁剪中间态)</label
        >
      </div>
      <button onclick="upload()" id="extractBtn">转换图片</button>
      <div id="status">请选择图片并点击“转换图片”</div>
    </div>

    <div class="container">
      <div class="box">
        <h3>原始图片</h3>
        <img id="original" />
      </div>

      <!-- OCR 裁剪中间态展示区 -->
      <div class="box" id="debugBox" style="display: none">
        <h3>智能裁剪</h3>
        <div class="transparent-bg">
          <img id="cropped" />
        </div>
      </div>

      <div class="box">
        <h3>处理结果</h3>
        <div class="transparent-bg">
          <img id="result" />
        </div>
      </div>
    </div>

    <script>
      const debugModeCheck = document.getElementById('debugMode')
      const debugBox = document.getElementById('debugBox')

      // 更新 UI：根据 Debug 开关显隐中间结果
      if (debugModeCheck) {
        debugModeCheck.addEventListener('change', (e) => {
          if (debugBox)
            debugBox.style.display = e.target.checked ? 'flex' : 'none'
        })
      }

      document
        .getElementById('uploadInput')
        .addEventListener('change', function (e) {
          const file = e.target.files[0]
          if (file) {
            const reader = new FileReader()
            reader.onload = (e) =>
              (document.getElementById('original').src = e.target.result)
            reader.readAsDataURL(file)

            //清空
            document.getElementById('result').src = ''
            const cropped = document.getElementById('cropped')
            if (cropped) cropped.src = ''
            document.getElementById('status').innerText =
              '图片已就绪，请点击转换'
          }
        })

      async function upload() {
        const input = document.getElementById('uploadInput')
        const file = input.files[0]
        if (!file) {
          alert('请先选择一张图片')
          return
        }

        const btn = document.getElementById('extractBtn')
        const status = document.getElementById('status')
        status.innerText = '正在处理中...'
        if (btn) btn.disabled = true

        const formData = new FormData()
        formData.append('file', file)

        const colorInput = document.getElementById('colorInput')
        const colorHex = colorInput ? colorInput.value : '#000000'

        const debugCheck = document.getElementById('debugMode')
        const isDebug = debugCheck ? debugCheck.checked : false

        let url = `/extract?color=${encodeURIComponent(colorHex)}&debug=${isDebug}`

        try {
          const response = await fetch(url, {
            method: 'POST',
            body: formData
          })

          if (response.ok) {
            if (isDebug) {
              // Debug 模式返回 JSON
              const data = await response.json()

              // 设置裁剪图
              if (data.cropped) {
                const croppedImg = document.getElementById('cropped')
                if (croppedImg)
                  croppedImg.src = 'data:image/png;base64,' + data.cropped
              }

              // 设置结果图
              if (data.result) {
                document.getElementById('result').src =
                  'data:image/png;base64,' + data.result
              }
              status.innerText = '✅ 转换成功 (Debug Mode)！'
            } else {
              // 普通模式返回图片 Blob
              const blob = await response.blob()
              const url = URL.createObjectURL(blob)
              document.getElementById('result').src = url
              status.innerText = '✅ 转换成功！'
            }
          } else {
            let errMsg = response.statusText
            try {
              const errData = await response.json()
              if (errData.detail) errMsg = errData.detail
            } catch (e) {}
            status.innerText = '❌ 错误: ' + errMsg
          }
        } catch (e) {
          console.error(e)
          status.innerText = '❌ 网络错误: ' + e.message
        } finally {
          if (btn) btn.disabled = false
        }
      }
    </script>
  </body>
</html>
